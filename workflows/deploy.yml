name: üöÄ Deploy to conversor.onza.me

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∏–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üîç Lint (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
        run: echo "–ó–¥–µ—Å—å –º–æ–≥—É—Ç –±—ã—Ç—å —Ç–µ—Å—Ç—ã –ª–∏–Ω—Ç–µ—Ä–∞"

  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üîë Setup SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: üåê Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: üöÄ Deploy to Server
        run: |
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "
            # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            TEMP_DIR=\"/tmp/conversor-deploy-\$(date +%s)\"
            mkdir -p \$TEMP_DIR
            
            # –ö–ª–æ–Ω–∏—Ä—É–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
            cd \$TEMP_DIR
            git clone --depth 1 https://github.com/${{ github.repository }}.git . || git pull
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            sudo rsync -avz --delete --exclude='.git' --exclude='.github' . /var/www/conversor.onza.me/html/
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞
            sudo chown -R deployer:www-data /var/www/conversor.onza.me/html
            sudo chmod -R 755 /var/www/conversor.onza.me/html
            
            # –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (Node.js/Python –∏ —Ç.–¥.)
            # npm install --production
            # pip install -r requirements.txt
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–ª—É–∂–±—ã –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            # sudo systemctl restart –≤–∞—à-—Å–µ—Ä–≤–∏—Å
            
            # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            cd && rm -rf \$TEMP_DIR
            
            echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!'
          "
      
      - name: üìä Health Check
        run: |
          curl -f https://conversor.onza.me || echo '‚ö†Ô∏è –°–∞–π—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'
